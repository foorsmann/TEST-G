
window.Webflow=window.Webflow||[];Webflow.push(async function(){if(window.__mediu_all_done)return;window.__mediu_all_done=1;"use strict";const W=window,D=document,$=(s,p=D)=>p.querySelector(s),a=(s,p=D)=>Array.from(p.querySelectorAll(s)),pad2=n=>String(n).padStart(2,"0"),HAS_PLYR=!!(W&&W.Plyr),isFastNet=()=>navigator&&navigator.connection&&navigator.connection.effectiveType==="4g",vib=()=>{try{navigator&&navigator.vibrate&&navigator.vibrate(50)}catch(_){}};D.body.classList.add("page-loading");(function(){const l=$(".lesson-loader");if(!l)return;["display","justifyContent","alignItems","position","inset","zIndex"].forEach((k,i)=>l.style.setProperty(k,["flex","center","center","fixed","0","999"][i],"important"))})();const params=new URLSearchParams(location.search),CHAP=params.get("chapter");if(!CHAP){alert("Capitolul nu a fost specificat.");return}if(!(window.firebase&&firebase.auth&&firebase.firestore)){alert("Firebase nu este disponibil.");return}const auth=firebase.auth(),db=firebase.firestore();const user=auth.currentUser||await new Promise(res=>auth.onAuthStateChanged(res));if(!user){alert("Trebuie sa fii autentificat.");location.href="/login";return}const QSEC=$(".question-section"),SHELL=$(".question-shell-w")||QSEC||D,WA=$(".question-wrapper-a",SHELL),WB=$(".question-wrapper-b",SHELL);if(!SHELL||!WA||!WB){alert("Structura A/B lipsă: pune .question-wrapper-a și .question-wrapper-b în .question-shell-w");return}(function(){const A="is-active",aA=WA.classList.contains(A),bA=WB.classList.contains(A);if(aA&&bA)WB.classList.remove(A);else if(!aA&&!bA)WA.classList.add(A)})();const FINAL=$(".chapter-final-screen");if(FINAL)FINAL.style.setProperty("display","none","important");if(QSEC)QSEC.style.setProperty("display","flex","important");const CNT=(QSEC&&QSEC.querySelector(".questions-collection-list-item-wrapper"))||QSEC||D.body,AWrap=$(".alert-wrapper-new");const SANITIZE=false,safe=html=>SANITIZE?(()=>{const d=D.createElement("div");d.textContent=String(html||"");return d.innerHTML})():html||"";const chapterDoc=await db.collection("mediu_invatare_chapters").doc(CHAP).get();if(!chapterDoc.exists){alert("Capitolul nu exista in baza de date!");return}const chapterName=chapterDoc.data().Name;async function getTotal(){const s=await db.collection("mediu_invatare_pages").where("chapterSlug","==",CHAP).get();return s.size}const TOTAL=await getTotal();const progCollection=db.collection("users").doc(user.uid).collection("progress_mediu"),ansCollection=db.collection("users").doc(user.uid).collection("answers_mediu"),progRef=progCollection.doc(CHAP);const pick=(arr,k)=>{const st=pick._||(pick._={correct:-1,wrong:-1});let i;do{i=Math.floor(Math.random()*arr.length)}while(arr.length>1&&i===st[k]);st[k]=i;return arr[i]??arr[0]},TXT_OK=["Corect 100%! -","Foarte bine! -","Bravo! -","Ai bifat corect! -","Ai rezolvat corect! -","Totul corect! -","Ai ales corect! -","Ai marcat corect! -"],TXT_BAD=["Gresit. Raspuns corect -","Nu e bine. Raspuns core -","Din pacate, nu. Raspuns core -","Mai incearca. Raspuns core -","Alegere gresita. Raspuns core -","Nu e varianta buna. Raspuns core -"];function ensureAI(btn){if(!btn)return;btn.textContent="AI CHAT";btn.setAttribute("aria-label","AI CHAT");btn.setAttribute("role","button")}function getWrapActive(){return WA.classList.contains("is-active")?WA:WB}function getWrapBuf(){return WA.classList.contains("is-active")?WB:WA}function collectRefs(w){const n=s=>w.querySelector(s),r={root:w,qEl:w.closest(".questions-collection-list-item")||w,qWrap:w,anchorTop:n(".explanation-anchor-top")||$(".explanation-anchor-top"),qText:n(".question-text"),progress:n(".progress-counter")||$(".progress-counter"),mainWrap:n(".main-content-wrapper")||$(".main-content-wrapper"),optWrap:n(".options-wrapper"),cards:a(".option-card",w),items:[],imgWrap:n(".question-image-wrapper"),img:n(".question-image"),videoWrap:n(".explanation-video-wrapper")||$(".explanation-video-wrapper"),acc:n(".custom-accordion")||$(".custom-accordion"),accHeader:null,accArrow:null,accContent:null,accBody:null,expLabelEl:null,accAnchor:null,feedbackWrap:n(".feedback-wrapper")||$(".feedback-wrapper"),staticText:null,correctAns:null,buttonsWrap:n(".submit-next-buttons")||$(".submit-next-buttons"),submitBtn:null,explainBtn:null,aiBtn:null,anchor:n(".explanation-anchor")||$(".explanation-anchor")};r.items=r.cards.map(c=>c.querySelector(".option-item"));if(r.acc){r.accHeader=r.acc.querySelector(".custom-accordion-header");r.accArrow=r.acc.querySelector(".custom-accordion-arrow");r.accContent=r.acc.querySelector(".custom-accordion-content");r.accBody=r.acc.querySelector(".custom-accordion-body");r.expLabelEl=r.acc.querySelector(".custom-accordion-label");r.accAnchor=r.acc.querySelector(".accordion-anchor")}if(r.feedbackWrap){r.staticText=r.feedbackWrap.querySelector(".correct-answer-static");r.correctAns=r.feedbackWrap.querySelector(".correct-answer")}if(r.buttonsWrap){r.submitBtn=r.buttonsWrap.querySelector(".submit-btn");r.explainBtn=r.buttonsWrap.querySelector(".explanation-btn")||r.buttonsWrap.querySelector(".explanation-card");r.aiBtn=r.buttonsWrap.querySelector(".ask-ai-btn")||r.buttonsWrap.querySelector(".ai-pop-wrapper")}return r}function noImageState(refs,on){const t=refs.qWrap||refs.root;if(!refs.optWrap||!t)return;if(on){t.classList.add("no-image");refs.optWrap.style.minHeight="40vh";if(refs.imgWrap)refs.imgWrap.style.display="none"}else{t.classList.remove("no-image");refs.optWrap.style.minHeight="";if(refs.imgWrap)refs.imgWrap.style.display=""}}async function setImg(refs,url){if(!refs.img){noImageState(refs,true);return}if(!url){refs.img.removeAttribute("src");refs.img.style.display="none";refs.img.setAttribute("aria-hidden","true");noImageState(refs,true);return}try{const t=new Image();t.decoding="async";try{t.fetchPriority="auto"}catch(_){ }t.src=url;if(t.decode)await t.decode();else await new Promise(r=>{t.onload=r;t.onerror=r})}catch(_){ }if(refs.img.src!==url)refs.img.src=url;refs.img.style.display="";refs.img.removeAttribute("aria-hidden");noImageState(refs,false);refs.img.onerror=()=>{refs.img.removeAttribute("src");refs.img.style.display="none";refs.img.setAttribute("aria-hidden","true");noImageState(refs,true)}}function setBtnState(btn,st){if(!btn)return;btn.classList.remove("is-verify","is-next","is-finish","finish-chapter-btn","_preload-full");if(st==="verify"){btn.textContent="VERIFICA";btn.classList.add("is-verify","_preload-full");btn.style.gridColumn="1 / 2"}else if(st==="next"){const last=WRMODE?(WRP===WRONG.length-1):(CUR===TOTAL);btn.textContent=last?"FINALIZEAZA":"CONTINUA";if(last)btn.classList.add("is-finish","finish-chapter-btn");else btn.classList.add("is-next");btn.style.gridColumn="2 / 3"}else{btn.textContent="FINALIZEAZA";btn.classList.add("is-finish","finish-chapter-btn");btn.style.gridColumn="2 / 3"}}function LfromCard(c){const el=c.querySelector(".option-letter");if(!el)return"";for(const n of el.childNodes){if(n.nodeType===Node.TEXT_NODE){const t=(n.nodeValue||"").trim();if(t)return t[0].toUpperCase()}}return(el.textContent||"").trim().charAt(0).toUpperCase()}function clearSel(sc){(sc||D).querySelectorAll(".option-letter.selected,.option-item.selected,.option-card-connector.selected").forEach(el=>el.classList.remove("selected"));(sc||D).querySelectorAll(".option-card.selected").forEach(el=>el.classList.remove("selected"))}function applySel(sc){(sc||D).querySelectorAll(".option-card").forEach(card=>{const L=LfromCard(card),on=SEL.includes(L);card.classList.remove("selected");card.querySelector(".option-letter")?.classList.toggle("selected",on);card.querySelector(".option-item")?.classList.toggle("selected",on);card.querySelector(".option-card-connector")?.classList.toggle("selected",on)})}function clearStates(sc){(sc||D).querySelectorAll(".option-letter").forEach(el=>el.classList.remove("correct","wrong"))}function applyStates(sc,cor){const COR=new Set((cor||[]).map(x=>String(x||"").trim().toUpperCase()));(sc||D).querySelectorAll(".option-card").forEach(card=>{const L=LfromCard(card),el=card.querySelector(".option-letter");if(!el||!L)return;el.classList.remove("correct","wrong");el.classList.add(COR.has(L)?"correct":"wrong")})}function clearWrong(sc){(sc||D).querySelectorAll(".option-card.wrong-card").forEach(c=>c.classList.remove("wrong-card"))}function applyWrong(sc,cor){const COR=new Set((cor||[]).map(x=>String(x||"").trim().toUpperCase()));(sc||D).querySelectorAll(".option-card").forEach(card=>{const L=LfromCard(card);card.classList.toggle("wrong-card",!COR.has(L))})}function bindSel(refs){refs.cards.forEach(card=>{if(card.dataset.boundSel==='1')return;card.addEventListener("click",()=>{if(ANSW)return;vib();const L=LfromCard(card);if(!L)return;SEL=SEL.includes(L)?SEL.filter(x=>x!==L):SEL.concat(L);applySel(refs.root)},{passive:true});card.dataset.boundSel='1'})}function bindAI(refs){if(!refs.aiBtn||refs.aiBtn.dataset.boundAi)return;ensureAI(refs.aiBtn);refs.aiBtn.addEventListener("click",()=>{vib();let pop=$(".ask-ai-pop-up");if(!pop){pop=D.createElement("div");pop.className="ask-ai-pop-up";Object.assign(pop.style,{display:"none",position:"fixed",inset:"0",justifyContent:"center",alignItems:"center",background:"rgba(0,0,0,.5)",backdropFilter:"blur(2px)",zIndex:"2147483647"});const box=D.createElement("div");Object.assign(box.style,{display:"flex",gap:"12px",alignItems:"center",background:"#121212",padding:"16px 20px",borderRadius:"12px",border:"1px solid #2a2a2a"});const mic=D.createElement("div");Object.assign(mic.style,{width:"36px",height:"36px",display:"flex",alignItems:"center",justifyContent:"center",borderRadius:"50%",overflow:"hidden"});const img=D.createElement("img");img.alt="AI";img.src="https://cdn.prod.website-files.com/68589124f5ef093107d3fdc2/685c48b463b6d0ce30731509_ChatGPT%20Image%20Jun%2020%2C%202025%2C%2001_39_41%20PM.png";img.style.width="100%";img.style.height="100%";img.style.objectFit="cover";mic.appendChild(img);const btn=D.createElement("button");btn.textContent="Audio AI";Object.assign(btn.style,{padding:"10px 14px",borderRadius:"10px",border:"1px solid #3a3a3a",background:"#1d1d1d",color:"#fff",cursor:"pointer"});const cls=D.createElement("button");cls.textContent="Închide";Object.assign(cls.style,{marginLeft:"8px",padding:"8px 12px",borderRadius:"8px",border:"1px solid #3a3a3a",background:"#1d1d1d",color:"#fff",cursor:"pointer"});box.append(mic,btn,cls);pop.appendChild(box);D.body.appendChild(pop);pop.addEventListener("click",e=>{if(e.target===pop||e.target===cls){pop.style.display="none";D.body.style.overflow=""}})}pop.style.display="flex";D.body.style.overflow="hidden"});refs.aiBtn.dataset.boundAi='1'}function lockButtons(refs,on){if(refs?.submitBtn){refs.submitBtn.setAttribute("aria-disabled",on?"true":"false");refs.submitBtn.classList.toggle("is-disabled",on)}if(refs?.buttonsWrap){on?refs.buttonsWrap.style.setProperty("pointer-events","none","important"):refs.buttonsWrap.style.removeProperty("pointer-events")}}function parseCorrect(q){return String(q["Correct Answers"]||"").split(",").map(x=>String(x||"").trim().toUpperCase()).filter(x=>x==="A"||x==="B"||x==="C")}let BUF={},SEL=[],ANSW=false,CUR=1,FIN=false,WRONG=[],WRMODE=false,WRP=0,WRONG_PREPARED=[],WRONG_PREPARED_READY=false,START_WRONG_IN_PROGRESS=false;function primeImg(u,{priority="auto"}={}){const i=new Image();i.decoding="async";try{i.fetchPriority=priority}catch(_){try{i.setAttribute("fetchpriority",priority)}catch(_){}}i.src=u;const ready=i.decode?i.decode():new Promise(r=>{i.onload=i.onerror=r});return{img:i,ready}}async function prefetchQ(idx){if(!idx||BUF[idx])return;let snap=await db.collection("mediu_invatare_pages").where("chapterSlug","==",CHAP).where("Index","==",idx).limit(1).get();if(snap.empty){try{snap=await db.collection("mediu_invatare_pages").where("chapterSlug","==",CHAP).where("Index","==",String(idx)).limit(1).get()}catch(_){}}if(snap.empty)return;const data=snap.docs[0].data();BUF[idx]=data;if(data.Image){try{const{ready}=primeImg(data.Image,{priority:"auto"});BUF[idx].__imgReady=ready;ready.catch(()=>{})}catch(_){BUF[idx].__imgReady=Promise.resolve()}}else BUF[idx].__imgReady=Promise.resolve()}async function prefetchMany(list,prio={}){const arr=(list||[]).filter(v=>v&&v>=1&&(!TOTAL||v<=TOTAL)&&!BUF[v]);if(!arr.length)return;try{const qs=await db.collection("mediu_invatare_pages").where("chapterSlug","==",CHAP).where("Index","in",arr.slice(0,10)).get();qs.forEach(doc=>{const d=doc.data(),i=d.Index;if(!i||BUF[i])return;BUF[i]=d;if(d.Image){const p=prio[i]||"low";try{const{ready}=primeImg(d.Image,{priority:p});BUF[i].__imgReady=ready;ready.catch(()=>{})}catch(_){BUF[i].__imgReady=Promise.resolve()}}else BUF[i].__imgReady=Promise.resolve()})}catch(_){await Promise.all(arr.map(v=>prefetchQ(v)))}}async function prefetchAhead(cur){const targets=[cur+1];if(isFastNet())targets.push(cur+2);const pr={};pr[cur+1]="auto";pr[cur+2]="low";await prefetchMany(targets,pr)}async function render(refs,idx,{resetSelections=false,skipRestore=false}={}){lockButtons(refs,true);const q=BUF[idx];if(!q)return;const c=refs.qWrap||refs.root,prev=c.offsetHeight;c.classList.add("no-transition","is-preparing");if(prev)c.style.minHeight=prev+"px";(refs.qEl.querySelector(".chapter-text")||D.createElement("div")).textContent=safe(chapterName);if(refs.progress)refs.progress.textContent=WRMODE?`${pad2(WRP+1)}/${pad2(WRONG.length)}`:`${pad2(CUR)}/${pad2(TOTAL)}`;refs.qText.innerHTML="";refs.qText.insertAdjacentHTML("afterbegin",safe(q.Question||""));const vals=[q["Option A"]||"",q["Option B"]||"",q["Option C"]||""];refs.cards.forEach((card,i)=>{const v=vals[i]||"",it=refs.items[i];if(it){it.innerHTML="";if(v)it.insertAdjacentHTML("afterbegin",safe(v))}card.style.display=v?"":"none"});if(refs.explainBtn)refs.explainBtn.style.display="none";if(refs.aiBtn)refs.aiBtn.style.display="none";refs.feedbackWrap?.style.setProperty("display","none","important");refs.correctAns&&(refs.correctAns.textContent="");refs.staticText&&(refs.staticText.textContent="Raspunsul corect este:");refs.explainBtn&&(refs.explainBtn.textContent="EXPLICATIE");if(resetSelections){SEL=[];ANSW=false}clearStates(refs.root);clearSel(refs.root);clearWrong(refs.root);refs.buttonsWrap?.classList.add("single-btn-state");setBtnState(refs.submitBtn,"verify");try{await(q.Image?(q.__imgReady||Promise.resolve()):Promise.resolve())}catch(_){ }if(q.Image){await setImg(refs,q.Image)}else{await setImg(refs,"")}if(!skipRestore&&!WRMODE){try{const s=await ansCollection.doc(`${CHAP}_${idx}`).get();if(s.exists){const d=s.data(),sel=(d.selected||[]).map(x=>String(x||"").toUpperCase()),cor=(d.correct||[]).map(x=>String(x||"").toUpperCase());if(sel.length>0){SEL=Array.from(new Set(sel));applySel(refs.root);ANSW=true;clearStates(refs.root);applyStates(refs.root,cor);clearWrong(refs.root);applyWrong(refs.root,cor);const same=SEL.slice().sort().join(",")===cor.slice().sort().join(",");refs.staticText&&(refs.staticText.textContent=same?pick(TXT_OK,"correct"):pick(TXT_BAD,"wrong"));const ord=["A","B","C"].filter(x=>cor.includes(x));refs.correctAns&&(refs.correctAns.textContent=ord.join(", "));refs.feedbackWrap?.style.setProperty("display","flex","important");refs.explainBtn?.style.setProperty("display","flex","important");refs.aiBtn?.style.setProperty("display","flex","important");ensureAI(refs.aiBtn);refs.buttonsWrap?.classList.remove("single-btn-state");const lastW=WRMODE&&(WRP===WRONG.length-1),lastN=!WRMODE&&(CUR===TOTAL);setBtnState(refs.submitBtn,(lastW||lastN)?"finish":"next")}}}catch(_){ }bindSel(refs);bindAI(refs);requestAnimationFrame(()=>{c.classList.remove("no-transition","is-preparing");c.style.minHeight="";lockButtons(refs,false)})}function hydrate(w){const r=collectRefs(w);w.classList.add("question-wrapper","q-fade");return r}let REFS_A=hydrate(WA),REFS_B=hydrate(WB),REFS=collectRefs(getWrapActive());const progSnap=await progRef.get();if(progSnap.exists){if(progSnap.data().currentIndex)CUR=progSnap.data().currentIndex;if(progSnap.data().finished)FIN=true}async function start(){await prefetchQ(CUR);const q=BUF[CUR];if(q&&q.__imgReady)try{await q.__imgReady}catch(_){ }await render(REFS,CUR,{resetSelections:false});getWrapActive().classList.add("q-fade","visible");D.body.classList.remove("page-loading")}if(!FIN){await start();await prefetchAhead(CUR)}else{if(FINAL)FINAL.style.setProperty("display","flex","important");if(QSEC)QSEC.style.setProperty("display","none","important")}const progressCounterFinal=$(".progress-counter-final"),barOuterFinal=$(".chapter-progress-bar-outer");let barGreenFinal=$(".chapter-final-screen .progress-green"),barRedFinal=$(".chapter-final-screen .progress-red"),barGapFinal=$(".chapter-final-screen .progress-gap");const RADIUS=3,GAP=3,GAPC="#070707",DUR=900;function ensureSeg(){if(!barOuterFinal)return;if(!barGreenFinal){barGreenFinal=D.createElement("span");barGreenFinal.className="progress-green";barOuterFinal.appendChild(barGreenFinal)}if(!barRedFinal){barRedFinal=D.createElement("span");barRedFinal.className="progress-red";barOuterFinal.appendChild(barRedFinal)}if(!barGapFinal){barGapFinal=D.createElement("span");barGapFinal.className="progress-gap";barOuterFinal.appendChild(barGapFinal)}}function applyBase(){if(!barOuterFinal)return;ensureSeg();Object.assign(barOuterFinal.style,{overflow:"hidden",position:"relative",display:"flex",borderRadius:`${RADIUS}px`});if(barGreenFinal)Object.assign(barGreenFinal.style,{position:"absolute",left:"0",top:"0",bottom:"0",borderRadius:`${RADIUS}px`,transition:"left .25s ease,width .25s ease"});if(barRedFinal)Object.assign(barRedFinal.style,{position:"absolute",top:"0",bottom:"0",borderRadius:`${RADIUS}px`,transition:"left .25s ease,width .25s ease"});if(barGapFinal)Object.assign(barGapFinal.style,{position:"absolute",top:"0",bottom:"0",width:`${GAP}px`,backgroundColor:GAPC,display:"none",pointerEvents:"none",borderRadius:`${RADIUS}px`})}let finalPctEl=null;function ensurePct(){if(!progressCounterFinal)return null;finalPctEl=progressCounterFinal.querySelector(".exam-final-percent");if(!finalPctEl){finalPctEl=D.createElement("span");finalPctEl.className="exam-final-percent";finalPctEl.textContent=progressCounterFinal.textContent.trim()||"0%";progressCounterFinal.textContent="";progressCounterFinal.appendChild(finalPctEl)}return finalPctEl}const setPct=v=>{ensurePct();if(finalPctEl)finalPctEl.textContent=String(v)};function animFinal(cPct,wPct,d=DUR){if(!barOuterFinal)return;applyBase();const ans=Math.max(0,Math.min(100,(+cPct||0)+(+wPct||0))),both=(+cPct>0)&&(+wPct>0);if(ans>0&&+cPct>0){if(both){barGreenFinal.style.width=`calc(${(cPct/ans)*100}% - ${GAP/2}px)`;barGreenFinal.style.left="0"}else{barGreenFinal.style.width="100%";barGreenFinal.style.left="0"}}else{barGreenFinal.style.width="0%";barGreenFinal.style.left="0"}if(ans>0&&+wPct>0){if(both){const left=(cPct/ans)*100;barRedFinal.style.left=`calc(${left}% + ${GAP/2}px)`;barRedFinal.style.width=`calc(${(wPct/ans)*100}% - ${GAP/2}px)`}else{barRedFinal.style.left="0";barRedFinal.style.width="100%"}}else{barRedFinal.style.left="0";barRedFinal.style.width="0%"}if(barGapFinal){if(both){const left=(cPct/ans)*100;barGapFinal.style.display="block";barGapFinal.style.left=`calc(${left}% - ${GAP/2}px)`}else barGapFinal.style.display="none"}barOuterFinal.style.transition=`width ${d}ms cubic-bezier(.68,-0.55,.27,1.55)`;barOuterFinal.style.width="0%";if(progressCounterFinal){setPct("0%");const st=performance.now();const step=t=>{const p=Math.min((t-st)/d,1),val=Math.round(p*(+cPct||0));setPct(val+"%");if(p<1)requestAnimationFrame(step)};requestAnimationFrame(step)}requestAnimationFrame(()=>{setTimeout(()=>{barOuterFinal.style.width=`${ans}%`},40)})}async function showFinal(){try{const tf=$(".chapter-text-final");if(tf&&chapterDoc.exists)tf.textContent=chapterDoc.data().Name}catch(_){ }const snap=await ansCollection.where("chapterSlug","==",CHAP).get();let ok=0,bad=0;snap.forEach(d=>{const v=d.data(),sel=(v.selected||[]).slice().sort().join(","),cor=(v.correct||[]).slice().sort().join(",");if(sel&&sel===cor)ok++;else if(sel)bad++});const safeT=(TOTAL&&TOTAL>0)?TOTAL:Math.max(1,ok+bad),cPct=Math.round((ok/safeT)*100),wPct=Math.round((bad/safeT)*100);$(".lesson-loader")?.style.setProperty("display","none","important");ensurePct();animFinal(cPct,wPct);FINAL?.style.setProperty("display","flex","important");if(QSEC)QSEC.style.setProperty("display","none","important");try{const pool=[];snap.forEach(doc=>{const d=doc.data(),sel=(d.selected||[]).slice().sort().join(","),cor=(d.correct||[]).slice().sort().join(",");if(sel&&sel!==cor){let idx=d.index;if(typeof idx!=="number"){const n=parseInt(idx,10);if(Number.isFinite(n))idx=n}if(typeof idx!=="number"){const m=String(doc.id||"").match(/_(\d+)$/);if(m)idx=parseInt(m[1],10)}if(typeof idx==="number"&&Number.isFinite(idx))pool.push(idx)}});WRONG_PREPARED=[...new Set(pool)].sort((a,b)=>a-b);WRONG_PREPARED_READY=false;if(WRONG_PREPARED.length){const pr={};pr[WRONG_PREPARED[0]]="auto";prefetchMany(WRONG_PREPARED,pr).finally(()=>{WRONG_PREPARED_READY=true})}else WRONG_PREPARED_READY=true}catch(_){WRONG_PREPARED=[];WRONG_PREPARED_READY=true}}async function buildWrong(){const pool=[],snap=await ansCollection.where("chapterSlug","==",CHAP).get();snap.forEach(doc=>{const d=doc.data(),sel=(d.selected||[]).slice().sort().join(","),cor=(d.correct||[]).slice().sort().join(",");if(sel&&sel!==cor){let idx=d.index;if(typeof idx!=="number"){const n=parseInt(idx,10);if(Number.isFinite(n))idx=n}if(typeof idx!=="number"){const m=String(doc.id||"").match(/_(\d+)$/);if(m)idx=parseInt(m[1],10)}if(typeof idx==="number"&&Number.isFinite(idx))pool.push(idx)}});return Array.from(new Set(pool)).sort((a,b)=>a-b)}async function flipTo(idx,{resetSelections=false}={}){const buf=getWrapBuf(),refs=collectRefs(buf);await render(refs,idx,{resetSelections});const act=getWrapActive();act.classList.remove("is-active","visible");buf.classList.add("is-active","visible");REFS=collectRefs(buf)}async function startWrong(){if(START_WRONG_IN_PROGRESS)return;START_WRONG_IN_PROGRESS=true;const loader=$(".lesson-loader"),act=getWrapActive();const h=act.offsetHeight;act.classList.add("no-transition","is-preparing");if(h)act.style.minHeight=h+"px";if(loader)loader.style.setProperty("display","flex","important");D.body.classList.add("page-loading");FINAL?.style.setProperty("display","none","important");if(QSEC)QSEC.style.setProperty("display","flex","important");try{let list=(WRONG_PREPARED_READY?WRONG_PREPARED:null);if(!list||!list.length)list=await buildWrong();if(!list.length){alert("Nu ai nicio intrebare gresita de refacut la acest capitol!");if(loader)loader.style.setProperty("display","none","important");FINAL?.style.setProperty("display","flex","important");act.classList.remove("no-transition","is-preparing");act.style.minHeight="";D.body.classList.remove("page-loading");START_WRONG_IN_PROGRESS=false;return}const pr={};pr[list[0]]="high";await prefetchMany(list,pr);await prefetchQ(list[0]);WRMODE=true;WRP=0;WRONG=list.slice(0);SEL=[];ANSW=false;await flipTo(WRONG[WRP],{resetSelections:true});await prefetchAhead(WRONG[WRP]||0)}catch(e){console.error("wrong-mode",e);alert("A apărut o eroare la încărcarea întrebărilor greșite.");FINAL?.style.setProperty("display","flex","important")}finally{if(loader)loader.style.setProperty("display","none","important");D.body.classList.remove("page-loading");act.classList.remove("no-transition","is-preparing");act.style.minHeight="";START_WRONG_IN_PROGRESS=false}}QSEC?.addEventListener("click",async e=>{const btn=e.target.closest(".submit-btn");if(!btn)return;e.preventDefault();vib();const isV=btn.classList.contains("is-verify"),isF=btn.classList.contains("is-finish")||btn.classList.contains("finish-chapter-btn"),isN=btn.classList.contains("is-next"),refs=collectRefs(getWrapActive()),idx=WRMODE?WRONG[WRP]:CUR;if(isF&&ANSW){try{await progRef.set({currentIndex:CUR,finished:true},{merge:true})}catch(_){ }WRMODE=false;await showFinal();return}if(isN&&ANSW){if(WRMODE){WRP++;if(WRP>=WRONG.length){WRMODE=false;try{await progRef.set({finished:true},{merge:true})}catch(_){ }await showFinal();return}await prefetchAhead(WRONG[WRP]||0);SEL=[];ANSW=false;await flipTo(WRONG[WRP],{resetSelections:true});return}else{if(CUR<TOTAL){CUR++;try{await progRef.set({currentIndex:CUR},{merge:true})}catch(_){ }await prefetchAhead(CUR);SEL=[];ANSW=false;await flipTo(CUR,{resetSelections:false})}else{try{await progRef.set({finished:true},{merge:true})}catch(_){ }await showFinal()}return}}if(isV){if(SEL.length===0){const t=AWrap?.querySelector(".select-answer-text");if(t)t.textContent="Selecteaza un raspuns!";if(AWrap){AWrap.style.display="flex";void AWrap.offsetWidth;AWrap.classList.add("active");setTimeout(()=>{AWrap.classList.remove("active");setTimeout(()=>{AWrap.style.display="none"},300)},1000)}try{new Audio("https://cdn.prod.website-files.com/68589124f5ef093107d3fdc2/686c8a3b23c385bd78509db1_videoplayback.mp3").play().catch(()=>{})}catch(_){ }refs.buttonsWrap?.classList.add("single-btn-state");btn.style.gridColumn="1 / 2";return}const q=BUF[idx];if(!q)return;const cor=parseCorrect(q);ANSW=true;clearStates(refs.root);applyStates(refs.root,cor);clearWrong(refs.root);applyWrong(refs.root,cor);const sel=SEL.slice().sort().join(","),ok=sel.length>0&&sel===cor.slice().sort().join(",");refs.staticText&&(refs.staticText.textContent=ok?pick(TXT_OK,"correct"):pick(TXT_BAD,"wrong"));const ord=["A","B","C"].filter(x=>cor.includes(x));refs.correctAns&&(refs.correctAns.textContent=ord.join(", "));refs.feedbackWrap?.style.setProperty("display","flex","important");refs.explainBtn?.style.setProperty("display","flex","important");refs.aiBtn?.style.setProperty("display","flex","important");ensureAI(refs.aiBtn);refs.buttonsWrap?.classList.remove("single-btn-state");const lastW=WRMODE&&(WRP===WRONG.length-1),lastN=!WRMODE&&(CUR===TOTAL);setBtnState(refs.submitBtn,(lastW||lastN)?"finish":"next");try{new Audio(ok?"https://cdn.prod.website-files.com/68589124f5ef093107d3fdc2/686893516d2a9d83db2a3c87_Correct.mp3":"https://cdn.prod.website-files.com/68589124f5ef093107d3fdc2/68689351194ed8c27e63b02d_Wong.mp3").play().catch(()=>{})}catch(_){ }Promise.all([ansCollection.doc(`${CHAP}_${idx}`).set({module:"mediu",chapterSlug:CHAP,index:idx,question:BUF[idx]?.Question||"",options:["A","B","C"].map(L=>({letter:L,value:BUF[idx]?.["Option "+L]||""})),selected:SEL.slice(),correct:cor.slice(),explanation:BUF[idx]?.["Explanation"]||"",answeredAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true}),progRef.set({currentIndex:CUR,finished:false},{merge:true})]).catch(()=>{})}});D.addEventListener("click",async e=>{if(e.target.closest(".reset-wrong-questions-only")){await startWrong();return}if(e.target.closest(".next-chapter-btn")){const s=await firebase.firestore().collection("mediu_invatare_chapters").orderBy("Index").get();const arr=[];s.forEach(d=>arr.push(d.id));const i=arr.indexOf(CHAP),next=(i!==-1&&i<arr.length-1)?arr[i+1]:null;if(next)location.replace(`${location.pathname}?chapter=${encodeURIComponent(next)}`);return}if(e.target.closest(".reset-chapter-btn")){$(".alert-wrapper")?.style.setProperty("display","flex","important");return}if(e.target.closest(".confirm-reset-chapter")){try{await progRef.delete();const qs=await ansCollection.where("chapterSlug","==",CHAP).get();const batch=firebase.firestore().batch();qs.forEach(doc=>batch.delete(doc.ref));await batch.commit();location.reload()}catch(_){alert("Eroare la resetarea progresului. Incearcă din nou.");$(".alert-wrapper")?.style.setProperty("display","none","important");FINAL?.style.setProperty("display","flex","important")}return}if(e.target.closest(".back-to-chapter-final-screen")){$(".alert-wrapper")?.style.setProperty("display","none","important");FINAL?.style.setProperty("display","flex","important");return}});D.addEventListener("keydown",e=>{const refs=collectRefs(getWrapActive());if(e.key==="Enter"){const b=refs?.submitBtn;if(b){e.preventDefault();b.click()}}else if(e.key==="Escape"){try{D.querySelectorAll(".alert-wrapper-new.active").forEach(w=>{w.classList.remove("active");w.style.display="none"});const ai=$(".ask-ai-pop-up");if(ai)ai.style.display="none";$(".lesson-loader")?.style.setProperty("display","none","important");D.body.classList.remove("page-loading");D.body.style.overflow=""}catch(_){}})});</script>
